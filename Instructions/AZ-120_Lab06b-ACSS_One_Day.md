---
lab:
  title: 06b - Azure SAP 解决方案中心 (ACSS) 部署和维护概述
  module: Design and implement an infrastructure to support SAP workloads on Azure
---

# AZ 1006 模块：设计和实现基础结构以支持 Azure 上的 SAP 工作负载
# AZ-1006 1 日课程实验室：Azure SAP 解决方案中心 (ACSS) 部署和维护概述

预计时间：100 分钟

此 AZ-1006 1 日课程实验室中的所有任务是从 Azure 门户执行的

## 目标

完成本实验室后，你将能够：

- 使用 Azure SAP 解决方案中心在 Azure 中部署和维护托管 SAP 工作负载的基础结构

## 说明

### 练习 0：创建并配置托管部署的虚拟网络

  >**注意**：如果将在练习 0 中使用 bicep 脚本化解决方案，请与讲师核对。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“虚拟网络”********。
1. 在“虚拟网络”页面上，选择“+ 创建”。
1. 在“创建虚拟机”页的“基本信息”选项卡中，指定以下设置并选择“下一页:************

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|CONTOSO-VNET-RG****|
    |虚拟网络名称|CONTOSO-VNET****|
    |区域|本实验室中前面预配了资源的 Azure 区域的名称|

1. 在“安全性”选项卡上，接受默认设置并选择“下一步”。********

    >**注意**：此时可以同时预配 Azure Bastion 和 Azure 防火墙，但在创建虚拟网络后，将单独预配它们。

1. 在“IP 地址”选项卡上，指定以下设置，然后选择“查看 + 创建”********：

    |设置|“值”|
    |---|---|
    |IP 地址空间|10.5.0.0/16（65,536 个地址）****|

    >**注意**：删除任何预先创建的子网条目。 创建虚拟网络后，将添加子网。

1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。
1. 导航回“虚拟网络”页，选择“CONTOSO-VNET”条目********。 
1. 在“CONTOSO-VNET”页上，在页面左侧的垂直菜单栏中，选择“子网”********。
1. 在“CONTOSO-VNET \| 子网”页上，选择“+ 子网”********。 
1. 在“添加子网”窗格中，指定以下设置，然后选择“保存”********：

    |设置|值|
    |---|---|
    |名称|app****|
    |子网地址范围|**10.5.0.0/24**|
    |网络安全组|ACSS-DEMO-NSG****|
    |路由表|ACSS-ROUTE****|

1. 返回“CONTOSO-VNET \| 子网”页，选择“+ 子网”********。 
1. 在“添加子网”窗格中，指定以下设置，然后选择“保存”********：

    |设置|值|
    |---|---|
    |名称|**AzureBastionSubnet**|
    |子网地址范围|10.5.1.0/26****|

1. 返回“CONTOSO-VNET \| 子网”页，选择“+ 子网”********。 
1. 在“添加子网”窗格中，指定以下设置，然后选择“保存”********：

    |设置|值|
    |---|---|
    |名称|**db**|
    |子网地址范围|10.5.2.0/24****|
    |网络安全组|ACSS-DEMO-NSG****|
    |路由表|ACSS-ROUTE****|

1. 返回“CONTOSO-VNET \| 子网”页，选择“+ 子网”********。 
1. 在“添加子网”窗格中，指定以下设置，然后选择“保存”********：

    |设置|值|
    |---|---|
    |名称|**AzureFirewallSubnet**|
    |子网地址范围|10.5.3.0/24****|

### 任务 8：将 Azure 防火墙部署到托管部署的虚拟网络中

>**注意**：在部署 Azure 防火墙实例之前，请首先创建防火墙策略和实例要使用的公共 IP 地址。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“防火墙策略”********。
1. 在“防火墙策略”页上，选择“+ 创建”********。
1. 在“创建 Azure 防火墙策略”页的“基本信息”选项卡中，指定以下设置并选择“下一页: ************ DNS 设置 >”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|CONTOSO-VNET-RG****|
    |名称|FirewallPolicy_contoso-firewall****|
    |区域|本实验室中前面预配了资源的 Azure 区域的名称|
    |策略层|**标准**|
    |父策略|**无**|

1. 在“DNS 设置”选项卡上，接受默认的“已禁用”选项，然后选择“下一页: ************ TLS 检查 >”。
1. 在“TLS 检查”选项卡上，选择“下一页: ******** 规则 >”。
1. 在“规则”**** 选项卡上，选择“+ 添加规则集合”****。
1. 在“添加规则集合”窗格中，指定以下设置****：

    |设置|值|
    |---|---|
    |名称|AllowOutbound****|
    |规则集合类型|**Network**|
    |优先级|**101**|
    |规则集合操作|**允许**|
    |规则集合组|DefaultNetworkRuleCollectionGroup|

1. 在“添加规则集合”窗格的“规则”部分中，添加具有以下设置的规则********：

    |设置|值|
    |---|---|
    |名称|**RHEL**|
    |源类型|**IP 地址**|
    |源|*|
    |协议|**任意**|
    |目标端口|*|
    |目标类型|**IP 地址**|
    |目标|13.91.47.76,40.85.190.91,52.187.75.218,52.174.163.213,52.237.203.198****|

    >**注意**：若要标识用于 RHEL 的 IP 地址，请参阅[为基础结构部署准备网络](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/prepare-network)

    |设置|值|
    |---|---|
    |名称|ServiceTags****|
    |源类型|**IP 地址**|
    |源|*|
    |协议|**任意**|
    |目标端口|*|
    |目标类型|**服务标记**|
    |目标|AzureActiveDirectory,AzureKeyVault,Storage****|

    >**注意**：如果愿意，可以使用具有区域范围的服务标签。 

    |设置|值|
    |---|---|
    |名称|**SUSE**|
    |源类型|**IP 地址**|
    |源|*|
    |协议|**任意**|
    |目标端口|*|
    |目标类型|**IP 地址**|
    |目标|52.188.224.179,52.186.168.210,52.188.81.163,40.121.202.140****|

    >**注意**：若要标识用于 SUSE 的 IP 地址，请参阅[为基础结构部署准备网络](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/prepare-network)

    |设置|值|
    |---|---|
    |名称|AllowOutbound****|
    |源类型|**IP 地址**|
    |源|*|
    |协议|TCP,UDP,ICMP,Any****|
    |目标端口|*|
    |目标类型|**IP 地址**|
    |目标|*|

1. 选择“添加”按钮以保存所有规则****。
1. 返回“规则”选项卡，选择“下一页: ******** IDPS >”。
1. 在“IDPS”选项卡上，选择“下一页: ******** 威胁情报 >”。

    >**注意**：IDPS 功能需要高级 SKU。

1. 在“威胁情报”选项卡上，查看可用设置而不进行任何更改，然后选择“查看 + 创建”********。
1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

    >**注意**：请等待防火墙策略预配完成。 预配大约需要 1 分钟。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“公共 IP 地址”********。
1. 在“公共 IP 地址”页上，选择“+ 创建”********。
1. 在“创建公共 IP 地址”页的“基本信息”选项卡上，指定以下设置，然后选择“查看 + 创建”************：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|CONTOSO-VNET-RG****|
    |区域|本实验室中前面预配了资源的 Azure 区域的名称|
    |名称|contoso-firewal-pip****|
    |IP 版本|**IPv4**|
    |SKU|**标准**|
    |可用性区域|无区域****|
    |层|**Regional**|
    |路由首选项|**Microsoft 网络**|
    |空闲超时(分钟)|**4**|
    |DNS 名称标签|未设置|

1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

    >**注意**：请等待公共 IP 地址预配完成。 预配大约需要几秒钟。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“防火墙”********。
1. 在“防火墙”页上，选择“+ 创建”********。
1. 在“创建防火墙”页的“基本信息”选项卡上，指定以下设置，然后选择“查看 + 创建”************：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|CONTOSO-VNET-RG****|
    |名称|contoso-firewall****|
    |区域|本实验室中前面预配了资源的 Azure 区域的名称|
    |可用性区域|**无**|
    |防火墙 SKU|**标准**|
    |防火墙管理|**使用防火墙策略来管理此防火墙**|
    |防火墙策略|FirewallPolicy_contoso-firewall****|
    |选择虚拟网络|**使用现有项**|
    |虚拟网络|CONTOSO-VNET****|
    |公共 IP 地址|contoso-firewall-pip****|
    |强制隧道|**已禁用**|

    >**注意**：请等待 Azure 防火墙预配完成。 预配可能需要大约 3 分钟。

1. 在 Azure 门户中，导航回“防火墙”页****。
1. 在“防火墙”页上，选择“contoso-firewall”条目********。
1. 在“contoso-firewall”页上，请注意“专用 IP”条目设置为“10.5.3.4”，表示 Azure 防火墙实例的专用 IP 地址************。

    >**注意**：为了通过 Azure 防火墙路由网络流量，需要将用户定义的路由添加到与托管 SAP 部署的虚拟网络的应用和数据库子网关联的路由表中。

1. 在 Azure 门户的“搜索”文本框中，搜索并选择“路由表”********。
1. 在“路由表”页上，选择“ACSS-ROUTE”条目********。
1. 在“ACSS-ROUTE”页上，选择“路由”********。
1. 在“ACSS-ROUTE \| 路由”页上，选择“+ 添加”********。
1. 在“添加路由”窗格中，指定以下设置，然后选择“添加”********：

    |设置|值|
    |---|---|
    |路由名称|**防火墙**|
    |目标类型|**IP 地址**|
    |目标 IP 地址/CIDR 范围|**0.0.0.0/0**|
    |下一跃点类型|**虚拟设备**|
    |下一跃点地址|10.5.3.4****|

### 任务 9：将 Azure Bastion 部署到托管部署的虚拟网络中

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“Bastion”********。 
1. 在“Bastion”页上，选择“+ 创建”********。
1. 在“Bastion”页的“基本信息”选项卡中，指定以下设置并选择“下一页: ************ 标签 >”：

    |设置|值|
    |---|---|
    |订阅|你在此实验室中使用的 Azure 订阅的名称|
    |资源组|CONTOSO-VNET-RG****|
    |名称|ACSS-BASTION****|
    |区域|本实验室中前面预配了资源的 Azure 区域的名称|
    |层|**基本**|
    |实例计数|**2**|
    |虚拟网络|CONTOSO-VNET****|
    |子网|**AzureBastionSubnet**|
    |公共 IP 地址|**新建**|
    |公共 IP 地址名称|ACSS-BASTION-PIP****|

1. 在“标签”选项卡上，选择“下一页: ******** 高级 &gt;”
1. 在“高级”选项卡上，查看可用设置而不进行任何更改，然后选择“下一页: ******查看 + 创建 >”**
1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

    >**注意**：请勿等待堡垒主机预配完成。 而是继续执行下一个任务。 预配可能需要大约 15 分钟。

### 练习 1：使用 Azure SAP 解决方案中心部署将在 Azure 中托管 SAP 工作负载的基础结构

持续时间：40 分钟

在本练习中，你将执行 Azure SAP 解决方案中心部署。 其中包括以下活动：

- 使用 Azure SAP 解决方案中心将能够托管 SAP 工作负载的基础结构部署到 Azure 订阅中。

此活动对应于本练习的以下任务：

- 任务 1：创建 SAP 解决方案虚拟实例 (VIS)

>**注意**：成功部署后，可以使用 Azure SAP 解决方案中心继续安装 SAP 软件。 但是，此实验室中不包括安装 SAP 软件。 

>**注意**：有关使用 Azure SAP 解决方案中心安装 SAP 软件的信息，请参阅介绍了如何[获取 SAP 安装介质](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/get-sap-installation-media)和[安装 SAP 软件](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/install-software)的 Microsoft Learn 文档。 

### 任务 1：创建 SAP 解决方案虚拟实例 (VIS)

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“Azure SAP 解决方案中心”********。 
1. 在“Azure SAP 解决方案中心 \| 概述”页上，选择“创建新的 SAP 系统”********。
1. 在“创建 SAP 解决方案虚拟实例”页的“基本信息”选项卡上，指定以下设置，然后选择“下一页: ************ 虚拟机”

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|新资源组的名称 acss-vi-RG********|
   |名称 (SID)|**VI1**|
   |区域|托管已注册 ACSS 的 SAP 部署的 Azure 区域的名称或同一地理位置中的另一个区域的名称|
   |环境类型|**非生产**|
   |SAP 产品|S/4HANA****|
   |数据库|HANA|
   |HANA 缩放方法|纵向扩展（推荐）****|
   |部署类型|**分布式，提供高可用性 (HA)**|
   |计算可用性|99.95（可用性集）****|
   |虚拟网络|CONTOSO-VNET****|
   |应用程序子网|应用 (10.5.0.0/24)****|
   |数据库子网|数据库 (10.5.2.0/24)****|
   |应用程序 OS 映像选项|**使用市场映像**|
   |应用程序 OS 映像|Red Hat Enterprise Linux 8.2 for SAP Applications - x64 Gen2 最新版****|
   |数据库 OS 映像选项|**使用市场映像**|
   |数据库 OS 映像|Red Hat Enterprise Linux 8.2 for SAP Applications - x64 Gen2 最新版****|
   |SAP 传输选项|创建新的 SAP 传输目录****|
   |传输资源组|ACSS-DEMO****|
   |存储帐户名称|无条目|
   |身份验证类型|SSH 公共****|
   |用户名|contososapadmin****|
   |SSH 公钥源|生成新密钥对|
   |密钥对名称|**contosovi1key**|
   |SQP FQDN|sap.contoso.com****|
   |托管标识源|使用现有的用户分配的托管标识****|
   |托管标识名称|Contoso-MSI****|

1. 在“虚拟机”选项卡上，指定以下设置****：

   |设置|“值”|
   |---|---|
   |基于以下内容生成建议|SAP 应用程序性能标准 (SAPS) – 选择此选项为应用层和数据库内存大小提供 SAPS，然后单击“生成建议”****|
   |应用层的 SAP|**1000**|
   |数据库的内存大小 (GiB)|**** 128|

1. 选择“生成建议”。
1. 查看 ASCS、应用程序和数据库虚拟机的 VM 大小和数量。 

   >**注意**：如果需要，请通过选择每组虚拟机的“查看所有大小”链接并选择替代大小来调整建议的大小。**** 默认情况下，具有高可用性的分布式部署类型以及上面指定的应用层 SAPS 和数据库内存大小会产生以下最小 VM SKU 建议：
   - 对于 ASCS VM，2 个 Standard_D4ds_v5（每个 VM 4 个 vCPU 和 16 GiB 内存）
   - 对于应用程序 VM，2 个 Standard_D4ds_v5（每个 VM 4 个 vCPU 和 16 GiB 内存）
   - 对于数据库 VM，2 个 Standard_E16ds_v5（每个 VM 16 个 vCPU 和 128 GiB 内存）

   >**注意**：如果需要，可以通过选择特定虚拟机 SKU 的“请求配额”链接并提交配额增加请求来请求增加配额。**** 处理请求通常需要几分钟时间。

   >**注意**：Azure SAP 解决方案中心在部署期间强制使用 SAP 支持的 VM SKU。

1. 在“虚拟机”选项卡上的“数据磁盘”部分中，选择“查看和自定义配置”链接************。
1. 在“数据库磁盘配置”页上，查看建议的配置而不进行任何更改，然后选择“关闭”********。
1. 回到“虚拟机”选项卡上，选择“下一页: ******** 可视化体系结构”。
1. 在“可视化体系结构”选项卡上，查看展示建议的体系结构的示意图，然后选择“查看 + 创建”********。
1. 在“查看 + 创建”选项卡上，等待验证过程完成，选中复选框以确认部署区域中有充足的可用配额，以避免遇到“配额不足”错误，然后选择“创建”********。
1. 出现提示时，在“生成新的密钥对”窗口中选择“下载私钥并创建资源”********。

   >**注意**：连接到部署中包含的 Azure VM 所需的私钥将下载到运行本实验室的计算机。

   >备注：请等待部署完成。 这可能需要大约 25 分钟。

   >**注意**：部署后，可以使用 Azure SAP 解决方案中心继续安装 SAP 软件。 在此实验室中，你将在不安装 SAP 软件的情况下，探索 Azure SAP 解决方案中心的功能。

### 练习 2：使用 Azure SAP 解决方案中心在 Azure 中维护 SAP 工作负载

持续时间：60 分钟

在本练习中，你将使用 Azure SAP 解决方案中心查看 SAP 工作负载的部署后管理和监视。 其中包括以下活动：

- 实现由 Azure SAP 解决方案中心管理的 SAP 工作负载备份的先决条件 
- 实现 Azure SAP 解决方案中心管理的 SAP 工作负载灾难恢复的先决条件 
- 查看适用于 Azure SAP 解决方案中心管理的 SAP 工作负载的监视选项 
- 删除此实验室中预配的所有 Azure 资源。

这些活动对应于本练习的以下任务：

- 任务 1：实现由 Azure SAP 解决方案中心管理的 SAP 工作负载备份的先决条件 
- 任务 2：实现 Azure SAP 解决方案中心管理的 SAP 工作负载灾难恢复的先决条件 
- 任务 3：查看 Azure SAP 解决方案中心管理的 SAP 工作负载的监视选项 
- 任务 4：删除本实验室中预配的 Azure 资源

#### 任务 1：实现由 Azure SAP 解决方案中心管理的 SAP 工作负载备份的先决条件

>**注意**：在 Azure SAP 解决方案中心，在 VIS 资源级别配置 Azure 备份时，可以在一个步骤中为托管数据库、应用程序服务器和 SAP Central Services 实例的 Azure VM 以及 HANA DB 启用备份。 对于 HANA DB 备份，Azure SAP 解决方案中心会自动运行备份预注册脚本。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“Azure SAP 解决方案中心”********。
1. 在“Azure SAP 解决方案中心 \| 概述”页上，在左侧的垂直导航菜单中，选择“SAP 解决方案虚拟实例”，然后在虚拟实例列表中，选择在上一练习中部署的实例********。
1. 在虚拟实例页左侧的垂直导航菜单中，在“操作”部分，选择“备份(预览)”********。
1. 请注意指示无法设置备份的消息，因为此 SAP 系统的 SAP 软件安装/注册未完成。

   >**注意**：这在预料之中。 在完成 SAP 软件的安装之前，将无法以这种方式设置备份。 但是，完成设置还涉及其他先决条件，包括创建保管库和备份策略，我们将在此处查看这些先决条件。 

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“备份中心”********。 
1. 在“备份中心”页左侧的垂直导航菜单中，在“管理”部分中，选择“保管库”************。
1. 在“备份中心 \| 保管库”页上，选择“+ 保管库”********。
1. 在“开始:**** 创建保管库”页上，查看可用的保管库类型，确保已选择“恢复服务保管库”（支持“Azure 虚拟机”和“Azure VM 中的 SAP HANA”数据源类型），然后选择“继续”****************。
1. 在“创建恢复服务保管库”页的“基本信息”选项卡上，指定以下设置，然后选择“下一步:************ 冗余”

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|新资源组的名称 acss-mgmt-RG********|
   |保管库名称|**acss-backup-RSV**|
   |区域|托管已注册 ACSS 的 SAP 部署的 Azure 区域的名称|

1. 在“冗余”选项卡上，指定以下设置，然后选择“下一步:******** 保管库属性”

   |设置|“值”|
   |---|---|
   |备份存储冗余|**异地冗余**|
   |跨区域还原|**启用**|

1. 在“保管库属性”选项卡上，查看“启用不可变性”设置而不启用它，然后选择“下一步:************ 网络”
1. 在“网络”选项卡上，接受默认选项“允许来自所有网络的公共访问”，然后选择“查看 + 创建”********
1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：等待预配过程完成。 预配可能需要大约 2 分钟。

1. 在“部署完成”面板上，选择“转到资源”********。
1. 在“acss-backup-RSV”页左侧的垂直导航菜单中，在“管理”部分中，选择“备份策略”************。
1. 在“acss-backup-RSV \| 备份策略”页上，选择“+ 添加”********。
1. 在“选择策略类型”页上，查看可用的策略类型****。

   >**注意**：首先，为托管数据库、应用程序服务器和 SAP Central Services 实例的 Azure VM 配置备份策略。

1. 在“选择策略类型”页上，选择“Azure 虚拟机”********。
1. 在“创建策略”页上，查看“标准”和“增强”策略子类型之间的差异，然后选择“增强”****************。

   >**注意**：应根据复原能力需求来选择。 同样，应根据需要调整下面列出的值。

1. 在“策略名称”文本框中，输入“acss-vm-enhanced-backup-policy”********。
1. 将备份计划频率设置为“每小时一次”，将开始时间设置为“下午 6:00”，将计划设置为“每 6 小时一次”，将持续时间设置为“12 小时”，将时区设置为本地时区****************。
1. 将“实例恢复快照保留期”值设置为 5 天********。
1. 将“每日备份点的保留期”设置为 60 天********。
1. 根据偏好设置每周、每月和每年备份点的保留期。

   >**注意**：若要启用分层，必须启用每月或每年备份点。

   >**注意**：还可以选择指定 Azure 备份自动生成的资源组的命名约定。

1. 选择**创建**。
1. 在“**部署完成**”面板上，选择“**转到资源**”。
1. 在“acss-backup-RSV”页左侧的垂直导航菜单中，在“管理”部分中，选择“备份策略”************。
1. 在“acss-backup-RSV \| 备份策略”页上，选择“+ 添加”********。

   >**注意**：接下来，将配置 HANA DB 的备份策略。 此处介绍的配置遵循 MS Learn 文章[在 Azure VM 上备份 SAP HANA 数据库实例快照](https://learn.microsoft.com/en-us/azure/backup/sap-hana-database-instances-backup)中所述的指南。

1. 在“选择策略类型”页上，选择“Azure VM 中的 SAP HANA (通过 Backint 的数据库)”********
1. 在“创建策略”页上的“策略名称”文本框中，输入“acss-hanadb-backint-backup-policy”************。
1. 接受完整备份和日志备份的默认设置。 使差异备份和增量备份保持禁用状态。

   >**注意**：可以选择启用 HANA 备份压缩并将符合条件的恢复点移动到保管库存档。 

1. 选择**创建**。

1. 在“**部署完成**”面板上，选择“**转到资源**”。
1. 在“acss-backup-RSV”页左侧的垂直导航菜单中，在“管理”部分中，选择“备份策略”************。
1. 在“acss-backup-RSV \| 备份策略”页上，选择“+ 添加”********。
1. 在“选择策略类型”页上，选择“Azure VM 中的 SAP HANA (通过快照的 DB 实例)”********
1. 在“创建策略”页上的“策略名称”文本框中，输入“acss-hanadb-snapshot-backup-policy”************。
1. 将快照备份的频率设置为当前时区的下午 1:30。
1. 配置为将即时恢复快照保留 5 天****。
1. 保留快照资源组的默认选择，应设置为“acss-mgmt-RG”****。
1. 在“托管标识”部分，选择“创建托管标识”********。 这将在 Web 浏览器窗口中自动打开另一个选项卡，在 Azure 门户中显示“托管标识”页****。
1. 在“托管标识”页上，选择“+ 创建”********。
1. 在“创建用户分配的托管标识”页的“基本信息”选项卡上，指定以下设置，然后选择“查看 + 创建”************：

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-mgmt-RG**|
   |区域|托管 ACSS 部署的 Azure 区域的名称|
   |名称|**acss-mgmt-MI**|

1. 在“查看”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：等待预配过程完成。 预配只需几秒钟即可完成。

1. 关闭当前浏览器选项卡，然后切换回显示“创建策略”页的浏览器选项卡****。
1. 在“托管标识”部分的“资源组”下拉列表中，选择“acss-mgmt-RG”，然后在“托管标识”下拉列表中选择“acss-mgmt-MI”********************。
1. 选择**创建**。

   >**注意**：在 Azure SAP 解决方案中心界面，在 VIS 级别配置备份时，你将能够利用现有的保管库及其策略。

   >**注意**：在 VIS 级别配置备份后，可以从 Azure 门户中的 VIS 界面监视 Azure VM 和 HANA DB 的备份作业的状态。

#### 任务 2：实现 Azure SAP 解决方案中心管理的 SAP 工作负载灾难恢复的先决条件 

>**注意**：虽然 Azure SAP 解决方案中心服务是区域冗余服务，但在发生区域中断时，Microsoft 不会启动故障转移。 若要修正此类方案，应按照 [SAP 工作负载的灾难恢复概述和基础结构指南](https://learn.microsoft.com/en-us/azure/sap/workloads/disaster-recovery-overview-guide)中所述的指导方法为使用 Azure SAP 解决方案中心部署的 SAP 系统配置灾难恢复，这涉及使用 Azure Site Recovery (ASR)。 在此任务中，你将依靠该指导方法，逐步完成实现基于 ASR 的灾难恢复解决方案的过程。

>**注意**：ASR 是适用于应用程序服务器和 SAP Central Services 实例的建议解决方案。 对于数据库服务器，应考虑使用本机复制功能。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“恢复服务保管库”********。
1. 在“恢复服务保管库”页上，选择“+ 创建”********。
1. 在“创建恢复服务保管库”页的“基本信息”选项卡上，指定以下设置（将其他设置保留为默认值）并选择“下一步:************ 冗余”。

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|新资源组的名称 acss-dr-RG********|
   |保管库名称|**acss-dr-RSV**|
   |区域|与已注册 ACSS 的 SAP 部署配对的 Azure 区域的名称|

   >**注意**：若要确定与托管生产工作负载的区域配对的区域，请参阅描述 [Azure 配对区域](https://learn.microsoft.com/en-us/azure/reliability/cross-region-replication-azure#azure-paired-regions)的 MS Learn 文档。

1. 在“冗余”选项卡上，指定以下设置，然后选择“下一步:******** 保管库属性”

   |设置|“值”|
   |---|---|
   |备份存储冗余|**本地冗余**|

1. 在“保管库属性”选项卡上，查看“启用不可变性”设置而不启用它，然后选择“下一步:************ 网络”
1. 在“网络”选项卡上，接受默认选项“允许来自所有网络的公共访问”，然后选择“查看 + 创建”********
1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：请勿等待预配完成，而是继续执行下一个步骤。 预配可能需要大约 2 分钟。

   >**注意**：现在，将在在其中创建了恢复服务保管库的配对区域中设置灾难恢复环境。 此环境将包括一个虚拟网络，该虚拟网络将托管在预配 SAP 虚拟实例的主要区域中当前托管的 Azure VM 的副本。 

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“搜索”文本框中搜索并选择“虚拟网络”********。 
1. 在“虚拟网络”页面上，选择“+ 创建”。
1. 在“创建虚拟机”页的“基本信息”选项卡中，指定以下设置并选择“下一页:************

   |设置|值|
   |---|---|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-dr-RG**|
   |虚拟网络名称|CONTOSO-VNET****|
   |区域|此任务早期创建恢复服务保管库时所用的同一 Azure 区域的名称|

1. 在“安全性”选项卡上，接受默认设置并选择“下一步”。********

   >**注意**：此时，可以同时预配 Azure Bastion 和 Azure 防火墙，但应在灾难恢复故障转移过程中自动执行其预配。 这将最大程度地减少与维护灾难恢复环境相关的费用。 这同样适用于该环境的其他组件，这些组件镜像主 SAP 虚拟实例的配置，例如 Azure 高级文件共享和自定义路由。

1. 在“IP 地址”选项卡上，指定以下设置，然后选择“查看 + 创建”********：

   |设置|“值”|
   |---|---|
   |IP 地址空间|**10.10.0.0/16（65,536 个地址）**|

   >**重要说明**：请注意，主要区域和次要区域中的虚拟网络之间的 IP 地址空间不同。 这是故意为之的，因为这样可以将两个虚拟网络连接在一起，在配置两个区域中托管的数据库服务器之间的复制需要此连接。 可以使用虚拟网络对等互连建立此类连接。 

1. 在子网列表中，选择垃圾桶图标以删除默认子网****。
1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|值|
   |---|---|
   |名称|**app**|
   |开始地址|**10.10.0.0**|
   |大小|**/24（256 个地址）**|

1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|值|
   |---|---|
   |名称|**db**|
   |开始地址|**10.10.2.0**|
   |大小|**/24（256 个地址）**|

1. 在“IP 地址”选项卡上，选择“查看 + 创建”********：
1. 在“查看 + 创建”选项卡上，等待验证过程完成，然后选择“创建”********。

   >**注意**：请勿等待预配过程完成，而是继续执行下一个任务。 预配只需几秒钟即可完成。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“恢复服务保管库”********。
1. 在“恢复服务保管库”页上，选择“acss-dr-RSV”********。
1. 在“acss-dr-RSV”页左侧垂直导航菜单的“开始”部分中，选择“Site Recovery”************。
1. 在“acss-dr-RSV \| Site Recovery”页上的“Azure 虚拟机”部分中，选择“1.**********启用复制**。 
1. 在“启用复制”页的“源”选项卡上，指定以下设置，然后选择“下一步”************：

   |设置|值|
   |---|---|
   |区域|托管 SAP 虚拟实例 (VIS) 的 Azure 区域的名称|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-vi-RG**|
   |虚拟机部署模型|**资源管理器**|
   |可用性区域之间的灾难恢复|**否**|

   >**注意**：可用性区域之间的灾难恢复可能不可配置，具体取决于源区域是否支持可用性区域****。

1. 在“虚拟机”选项卡上，选择列表中的前四个虚拟机（vi1appvm0、vi1appvm1、vi1ascsvm0 和 vi1ascsvm0），然后选择“下一步”************************。

   >**注意**：如前所述，基于 ASR 的复制将应用于应用程序服务器和 SAP Central Services 实例。 依靠本机数据库复制功能，数据库服务器将保持同步。

1. 在“复制设置”选项卡中，执行以下操作****：

   1. 如果需要，请在“目标位置”下拉列表中选择在其中创建了 acss-dr-RSV 恢复服务保管库的 Azure 区域********。
   1. 确保在此实验室中正在使用的 Azure 订阅的名称显示在“目标订阅”下拉列表中****。
   1. 在“目标资源组”下拉列表中，选择“acss-dr-RG”********。
   1. 在“故障转移虚拟网络”下拉列表中，选择“CONTOSO-VNET”********。
   1. 在“故障转移子网”下拉列表中，选择“应用(10.10.0.0/24)”********。
   1. 在“存储”部分中，选择“查看/编辑存储配置”链接********。
   1. 在“自定义目标设置”页上，查看生成的配置，但不进行任何更改，然后选择“取消”********。
   1. 在“可用性选项”部分中，选择“查看/编辑可用性选项”链接********。
   1. 在“可用性选项”页上，请注意，虽然可以选择为目标资源实现邻近放置组，但请勿进行任何更改，然后选择“取消”********。

   >**注意**：还可以选择配置容产能预留。

1. 返回“启用复制”页的“复制设置”选项卡，选择“下一步”************。
1. 在“启用复制”页的“管理”选项卡上，执行以下操作********：

   1. 在“复制策略”下拉列表下方，选择“新建”********。
   1. 在“创建复制策略”窗格中的“名称”文本框中，输入“2-day-retention-policy”，在“保留期(天)”文本框中输入“2”，然后选择“确定”************************。
   1. 请注意，可以选择创建复制组。 但此选项不适用于我们的用例。
   1. 将“扩展设置”的“更新设置”选项保留“允许 ASR 管理”配置************。
   1. 接受自动分配的默认自动化帐户名称****。

1. 在“启用复制”页的“管理”选项卡上，选择“下一步”************。
1. 在“启用复制”页的“查看”选项卡上，选择“启用复制”  。

   >**注意**：现在，你将逐步为托管数据库服务器的其余两个 Azure VM 启用复制。

1. 返回“acss-dr-RSV \| Site Recovery”页上的“Azure 虚拟机”部分，选择“1.**********启用复制**。 
1. 在“启用复制”页的“源”选项卡上，指定以下设置，然后选择“下一步”************：

   |设置|值|
   |---|---|
   |区域|托管 SAP 虚拟实例 (VIS) 的 Azure 区域的名称|
   |订阅|你在此实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-vi-RG**|
   |虚拟机部署模型|**资源管理器**|
   |可用性区域之间的灾难恢复|**否**|

   >**注意**：可用性区域之间的灾难恢复可能不可配置，具体取决于源区域是否支持可用性区域****。

1. 在“虚拟机”选项卡上，选择列表中的前四个虚拟机（vi1appvm0、vi1appvm1、vi1ascsvm0 和 vi1ascsvm0），然后选择“下一步”************************。

   >**注意**：需要单独为其余两个 Azure VM 配置复制，因为它们已连接到其他子网。

1. 在“复制设置”选项卡中，执行以下操作****：

   1. 如果需要，请在“目标位置”下拉列表中选择在其中创建了 acss-dr-RSV 恢复服务保管库的 Azure 区域********。
   1. 确保在此实验室中正在使用的 Azure 订阅的名称显示在“目标订阅”下拉列表中****。
   1. 在“目标资源组”下拉列表中，选择“acss-dr-RG”********。
   1. 在“故障转移虚拟网络”下拉列表中，选择“CONTOSO-VNET”********。
   1. 在“故障转移子网”下拉列表中，选择“应用(10.10.0.0/24)”********。
   1. 在“存储”部分中，选择“查看/编辑存储配置”链接********。
   1. 在“自定义目标设置”页上，查看生成的配置，但不进行任何更改，然后选择“取消”********。
   1. 在“可用性选项”部分中，选择“查看/编辑可用性选项”链接********。
   1. 在“可用性选项”页上，请注意，虽然可以选择为目标资源实现邻近放置组，但请勿进行任何更改，然后选择“取消”********。

   >**注意**：还可以选择配置容产能预留。

1. 返回“启用复制”页的“复制设置”选项卡，选择“下一步”************。
1. 在“启用复制”页的“管理”选项卡上，执行以下操作********：

   1. 在“复制策略”下拉列表下方，选择“新建”********。
   1. 在“创建复制策略”窗格中的“名称”文本框中，输入“2-day-retention-policy”，在“保留期(天)”文本框中输入“2”，然后选择“确定”************************。
   1. 请注意，可以选择创建复制组。 但此选项不适用于我们的用例。
   1. 将“扩展设置”的“更新设置”选项保留“允许 ASR 管理”配置************。
   1. 接受自动分配的默认自动化帐户名称****。

1. 在“启用复制”页的“管理”选项卡上，选择“下一步”************。
1. 在“启用复制”页的“查看”选项卡上，选择“启用复制”  。

   >**注意**：初次复制可能需要相当长的时间才能完成。 考虑到分配给此实验室的时间有限，演示实际的故障转移是不可行的，因此本练习的剩余步骤是可选的，主要取决于会话结束前剩余的时间。

1. 在“acss-dr-RSV”页左侧的垂直导航菜单中，在“受保护的项”部分中，选择“复制的项”************。
1. 在“acss-dr-RSV \| 复制的项”页上，查看四个 Azure VM 的复制状态****。

   >**注意**：可能需要几分钟时间才能显示复制状态。 状态在最初应设置为“正在启用复制”，然后转换为“已同步 x%”，直到同步过程完成********。 在该阶段，状态将更改为“等待第一个恢复点”，最后切换为“受保护”********。 等到“acss-dr-RSV \| 复制的项”页中列出的 Azure VM 的状态更改为“受保护”********。 这表示已准备好启动测试故障转移（如果打算验证生成的设置而不调用灾难恢复）或故障转移（如果要将主实例上托管的工作负载过渡到其副本上）。 故障转移的任一形式都将在灾难恢复区域中预配和引入主要区域 Azure VM 的联机副本。 

1. 若要执行测试故障转移或故障转移，请在“acss-dr-RSV \| 复制的项”页上，选择表示其中一个受保护 Azure VM 的条目，然后在该 Azure VM 的“复制的项”页上，选择“测试故障转移”或“故障转移”****************。 

   >**注意**：如果选择“测试故障转移”，系统会提示提供要使用的恢复点以及副本 Azure VM 应连接到的 Azure 虚拟网络****。 可以将其用于 CONTOSO-VNET Azure 虚拟网络****。 或者，可以实现完全隔离的测试环境，但请记住，你需要提供与数据库服务器副本的连接，以便执行更全面的测试。

   >**注意**：测试故障转移完成后，从单独的“复制的项”页调用“清理测试故障转移”，只需删除副本 Azure VM 即可********。 如果调用了故障转移，则需要在故障转移完成后将更改提交到副本 Azure VM，然后逆转复制方向，有效地将主要区域视为新的灾难恢复站点，从而为其重新提供保护********。 若要返回到原始安排，请执行另一次故障转移，这次从次要区域转移到主要区域。

#### 任务 3：查看 Azure SAP 解决方案中心管理的 SAP 工作负载的监视选项 

>**注意**：与备份一样，你将无法完整体验 Azure SAP 解决方案中心的监视功能。 这需要安装 SAP 软件或注册现有的 Azure SAP 解决方案监视器实例。 相反，在此任务中，你将逐步体验 SAP 解决方案虚拟实例中提供的接口，以识别和查看这些功能。

1. 在实验室计算机上，在显示 Azure 门户的 Microsoft Edge 窗口中，在“搜索”文本框中搜索并选择“SAP 解决方案虚拟实例”********。 
1. 在“SAP 解决方案虚拟实例”页上，查看 VI1 实例的汇总状态信息，包括总体运行状况和状态可视指标********。
1. 在“SAP 解决方案虚拟实例”页上，选择“VI1”********。
1. 在“VI1”页左侧的垂直导航菜单中，选择“概述”，然后在右侧的窗格中选择“监视”************。
1. 查看监视窗格中显示的监视遥测数据。

   >**注意**：监视窗格包括应用程序服务器、数据库服务器和 SAP Central Services 实例的 vCPU 使用率图和指标。 它还包括数据库磁盘 IOPS 统计信息数据库服务器。 

1. 在“VI1”页左侧的垂直导航菜单中，在“监视”部分，选择“质量见解”************。
1. 在“VI1 \| 质量见解 \| 工作簿 1”页上，查看“顾问建议”选项卡，该选项卡旨在提供有关优化 SAP 解决方案虚拟示例 (VIS)、中央服务器实例、应用服务实例和数据库的建议********。

   >**注意**：这些建议需要完成 SAP 软件的安装。

1. 在“VI1 \| 质量见解 \| 工作簿 1”页上，选择“虚拟机”选项卡并查看“Azure 计算”、“计算列表”、“计算扩展”、“计算 + OS 磁盘”和“计算 + 数据磁盘”选项卡的内容****************************。

   >**注意**：每个选项卡都应包括从 SAP 解决方案虚拟实例中的 Azure VM 收集的实际数据。

1. 在“VI1 \| 质量见解 \| 工作簿 1”页上，选择“配置检查”选项卡并查看“加速网络”、“公共 IP”、“备份”和“负载均衡器”选项卡的内容************************。 此内容简要概述了 SAP 解决方案虚拟实例的计算和网络组件的性能和安全性相关设置。 “负载均衡器”选项卡包括显示关键负载均衡器指标的负载均衡器监视器信息********。
1. 在“VI1”页左侧的垂直导航菜单中，在“监视”部分，选择“Azure SAP 解决方案监视器”************。
1. 在“VI1 \| Azure SAP 解决方案监视器”页上，记下一条消息，该消息指出 AMS 无法设置，因为 VIS 的 SAP 软件安装\注册未完成****。

   >**注意**：安装 SAP 软件后，即可将其与新的或现有的 Azure SAP 解决方案监视器资源集成。 Azure SAP 解决方案监视器依赖于 Log Analytics 和工作簿的 Azure Monitor 功能来全面监视 Azure VM 上托管的 SAP 工作负载，包括对自定义可视化效果、查询和警报的支持。