---
lab:
  title: 06a - 部署 Azure SAP 解决方案中心 (ACSS) 的先决条件概述
  module: Design and implement an infrastructure to support SAP workloads on Azure
---

# AZ 1006 模块：设计和实现基础结构以支持 Azure 上的 SAP 工作负载
# AZ-1006 1 天课程实验室：通过 Azure SAP 解决方案中心 (ACSS) 部署 SAP 工作负载的先决条件概述

预计时间：100 分钟

此 AZ-1006 1 日课程实验室中的所有任务是从 Azure 门户执行的

## 目标

完成本实验后，你将能够：

- 实现使用 Azure SAP 解决方案中心在 Azure 中部署 SAP 工作负载的先决条件

## 说明

### 练习 1：实现使用 Azure SAP 解决方案中心在 Azure 中部署 SAP 工作负载的先决条件

持续时间：60 分钟

在本练习中，你将查看并实现使用 Azure SAP 解决方案中心在 Azure 中部署 SAP 工作负载的先决条件。 这包括以下活动：

- 创建 Microsoft Entra 用户分配的托管标识，以供 Azure SAP 解决方案中心在其部署期间用于 Azure 存储访问。
- 创建负责托管部署中包含的所有 Azure 虚拟机的 Azure 虚拟网络。
- 创建 Azure Bastion 资源以保护从 Internet 到 Azure VM 的连接。
- 创建与用于部署的 Azure SAP 解决方案中心关联的 Azure 存储常规用途 v2 帐户
- 授予用于执行部署的 Microsoft Entra 用户分配的托管标识对 Azure 订阅和 Azure 存储常规用途 v2 帐户的访问权限
- 创建用于实现 SAP 传输目录的 Azure 高级文件共享帐户
- 创建和配置网络安全组 (NSG)，它用于限制来自托管部署的虚拟网络子网的出站访问。
- 创建要用于 SAP 软件安装的 Azure 虚拟机 (VM)，作为 Azure SAP 解决方案中心部署的一部分。
- 使用 Azure Bastion 连接到 Azure VM，并配置它来进行 SAP 软件安装。
- 删除此实验室中预配的所有 Azure 资源。

这些活动对应于本练习的以下任务：

- 任务 1：创建 Microsoft Entra 用户分配的托管标识
- 任务 2：创建 Azure 虚拟网络
- 任务 3：创建 Azure Bastion资源
- 任务 4：创建 Azure 存储常规用途 v2 帐户
- 任务 5：配置 Microsoft Entra 用户分配的托管标识的授权
- 任务 6：创建 Azure 高级文件共享帐户
- 任务 7：创建和配置网络安全组
- 任务 8：创建一个 Azure 虚拟机
- 任务 9：配置 Azure 虚拟机
- 任务 10：删除 Azure 资源

#### 任务 1：创建 Microsoft Entra 用户分配的托管标识

在此任务中，你将创建一个 Microsoft Entra 用户分配的托管标识，以供 Azure SAP 解决方案中心在其部署期间用于 Azure 存储访问。

1. 在实验室计算机中启动 Web 浏览器，导航到位于 `https://portal.azure.com` 的 Azure 门户，并使用你在此实验室中使用的 Azure 订阅所有者角色通过 Microsoft 帐户或 Microsoft Entra ID 帐户进行身份验证。
1. 在显示 Azure 门户的 Web 浏览器窗口中的“**搜索**”文本框中，搜索并选择“**托管标识**”。
1. 在“托管标识”页上，选择“+ 创建”********。
1. 在“创建用户分配的托管标识”页的“基本信息”选项卡上，指定以下设置，然后选择“查看 + 创建”************：

   |设置|值|
   |---|---|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |区域|你用于 ACSS 部署的 Azure 区域的名称|
   |名称|**acss-infra-MI**|

1. 在“查看”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：请勿等待预配完成，而是继续执行下一个任务。 预配只需几秒钟即可完成。

   >**注意**：在即将执行的一项任务中，你将授权托管标识访问托管 SAP 安装媒体的存储帐户，以适应通过 Azure SAP 解决方案中心安装 SAP 软件。

#### 任务 2：创建虚拟网络

在此任务中，你将创建托管部署中包含的所有 Azure 虚拟机的 Azure 虚拟网络。 此外，在虚拟网络中，你将创建以下子网：

- AzureFirewallSubnet - 用于部署 Azure 防火墙
- AzureBastionSubnet - 用于部署 Azure Bastion
- dmz - 用于部署用于部署 SAP 软件的 Azure VM
- 应用 - 用于托管 SAP 应用程序和 SAP Central Services 实例服务器
- db - 用于托管 SAP 数据库层

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**虚拟网络**”。 
1. 在“虚拟网络”页面上，选择“+ 创建”。
1. 在“创建虚拟机”页的“基本信息”选项卡中，指定以下设置并选择“下一页:************

   |设置|值|
   |---|---|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |虚拟网络名称|**acss-infra-VNET**|
   |区域|本练习上一任务中使用的同一 Azure 区域的名称|

1. 在“安全性”选项卡上，接受默认设置并选择“下一步”。********

   >**注意**：此时可以同时预配 Azure Bastion 和 Azure 防火墙，但在创建虚拟网络后，将单独预配它们。

1. 在“IP 地址”选项卡上，指定以下设置，然后选择“查看 + 创建”********：

   |设置|“值”|
   |---|---|
   |IP 地址空间|**10.0.0.0/16（65,536 个地址）**|

1. 在子网列表中，选择垃圾桶图标以删除**默认**子网。
1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|“值”|
   |---|---|
   |子网用途|**Azure 防火墙**|
   |开始地址|**10.0.0.0**|

   >**注意**：这会自动向子网分配名称 **AzureFirewallSubnet**，并将其大小设置为 **/26（64 个地址）**。

1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|值|
   |---|---|
   |名称|**dmz**|
   |开始地址|**10.0.0.128**|
   |大小|**/26（64 个地址）**|

   >**注意**：此子网将用于托管 Azure VM，你将使用它通过 Azure SAP 解决方案中心安装 SAP 软件。

1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|“值”|
   |---|---|
   |子网用途|**Azure Bastion**|
   |开始地址|**10.0.1.0**|
   |大小|**/24（256 个地址）**|

   >**注意**：此操作会自动向子网分配名称 **AzureBastionSubnet**。

1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|值|
   |---|---|
   |名称|**app**|
   |开始地址|**10.0.2.0**|
   |大小|**/24（256 个地址）**|

1. 选择“+添加子网”。
1. 在“添加子网”窗格中，指定以下设置，然后选择“添加”（将其他项保留为默认值）********：

   |设置|值|
   |---|---|
   |名称|**db**|
   |开始地址|**10.0.3.0**|
   |大小|**/24（256 个地址）**|

1. 在“IP 地址”选项卡上，选择“查看 + 创建”********：
1. 在“查看 + 创建”选项卡上，等待验证过程完成，然后选择“创建”********。

   >**注意**：请勿等待预配过程完成，而是继续执行下一个任务。 预配只需几秒钟即可完成。

#### 任务 3：创建 Azure Bastion资源

在此任务中，你将创建一个 Azure Bastion 资源，以保护从 Internet 到 Azure VM 的连接。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**Bastion**”。 
1. 在“Bastion”页上，选择“+ 创建”********。
1. 在“Bastion”页的“基本信息”选项卡中，指定以下设置并选择“下一页: **********高级 >**：

   |设置|值|
   |---|---|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |名称|**acss-infra-BASTION**|
   |区域|本练习前面使用的同一 Azure 区域的名称|
   |层|**基本**|
   |实例计数|**2**|
   |虚拟网络|**acss-infra-VNET**|
   |子网|**AzureBastionSubnet (10.0.1.0/24)**|
   |公共 IP 地址|**新建**|
   |公共 IP 地址名称|**acss-bastion-PIP**|

1. 在“**高级**”选项卡上，查看可用设置而不进行任何更改，然后选择“**查看 + 创建**”。
1. 在“**查看 + 创建**”选项卡上，等待验证过程完成，然后选择“**创建**”。

   >**注意**：请勿等待预配完成，而是继续执行下一个任务。 预配可能需要大约 5 分钟才能完成。

#### 任务 4：创建 Azure 存储常规用途 v2 帐户

在此任务中，你将创建一个 Azure 存储常规用途 v2 帐户，该帐户与用于部署的 Azure SAP 解决方案中心相关联。 此存储帐户用于托管 SAP 安装媒体，以适应通过 Azure SAP 解决方案中心安装 SAP 软件。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**存储帐户**”。
1. 在“存储帐户”页上，选择“+ 创建” 。
1. 在“创建存储帐户”页的“基本信息”选项卡上，指定以下设置并选择“下一页: ************ 高级 &gt;”。

   |设置|值|
   |---|---|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |存储帐户名称|由字母和数字组成、长度介于 3 到 24 个字符之间的任意全局唯一名称|
   |区域|本练习前面使用的同一 Azure 区域的名称|
   |性能|**标准**|
   |冗余|**异地冗余存储 (GRS)**|
   |在区域可用的情况下，提供对数据的读取访问|已禁用|

1. 在“高级”选项卡上，查看可用选项，接受默认设置，然后选择“下一页: ******** 网络 >”。
1. 在“**网络**”选项卡上，执行以下操作，然后选择“**查看**”。

   1. 选择“**启用来自所选虚拟网络和 IP 地址的公共访问**”。
   1. 在“**虚拟网络**”部分中，确保“**虚拟网络订阅**”下拉列表显示你在本实验室中使用的 Azure 订阅的名称。
   1. 在“**虚拟网络**”部分的“**虚拟网络**”下拉列表中，选择“**acss-infra-VNET**”。
   1. 在“**子网**”下拉列表中，选择“**应用**”、“**db**”和“**dmz**”子网。

1. 在“查看”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：等待预配过程完成。 预配用时应会少于 1 分钟。

1. 在“**部署完成**”面板上，选择“**转到资源**”。
1. 在存储帐户页上左侧垂直导航菜单的“**数据存储**”部分中，选择“**容器**”。
1. 选择“+ 容器”。
1. 在“**新建容器**”窗格的“**名称**”文本框中，输入 **sapbits**，然后选择“**创建**”。

   >**注意**：**sapbits** 容器将托管 SAP 安装介质。

#### 任务 5：配置 Microsoft Entra 用户分配的托管标识的授权

在此任务中，你将使用 Azure 基于角色的访问控制 (RBAC) 角色分配来授予 Microsoft Entra 用户分配的托管标识。 托管标识用于执行对 Azure 订阅和上一任务中创建的 Azure 存储常规用途 v2 帐户的部署访问权限。

1. 在 Azure 门户中，在显示 Azure 门户的 Web 浏览器窗口的“**搜索**”文本框中，搜索并选择“**托管标识**”。
1. 在“托管标识”页上，选择“**acss-infra-MI**”条目。
1. 在“**acss-infra-MI**”页上左侧垂直导航菜单中，选择“**Azure 角色分配**”。
1. 在“Azure 角色分配”页上，选择“+ 添加角色分配(预览版)”********。
1. 在“+ 添加角色分配(预览版)”窗格上，指定以下设置并选择“保存”********：

   |设置|值|
   |---|---|
   |范围|**订阅**|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |角色|**Azure SAP 解决方案中心服务角色**|

1. 回到“Azure 角色分配”页上，选择“+ 添加角色分配(预览版)”********。
1. 在“+ 添加角色分配(预览版)”窗格上，指定以下设置并选择“保存”********：

   |设置|值|
   |---|---|
   |作用域|**存储**|
   |订阅|你在本实验室中使用的 Azure 订阅的名称|
   |资源|你在前面的任务中创建的 Azure 存储帐户的名称|
   |角色|**读取器和数据访问**|

#### 任务 6：创建 Azure 高级文件共享帐户

在此任务中，你将创建一个 Azure 高级文件共享帐户，用于实现 SAP 传输目录。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**存储帐户**”。
1. 在“存储帐户”页上，选择“+ 创建” 。
1. 在“创建存储帐户”页的“基本信息”选项卡上，指定以下设置并选择“下一页: ************ 高级 &gt;”。

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |存储帐户名称|由字母和数字组成、长度介于 3 到 24 个字符之间的任意全局唯一名称|
   |区域|本练习前面使用的同一 Azure 区域的名称|
   |性能|**高级**|
   |高级帐户类型|**文件共享**|
   |冗余|**区域冗余存储 (ZRS)**|

1. 在“**高级**”选项卡上，禁用“**需要安全传输以执行 REST API 操作**”设置，然后选择“**下一步:** 网络 >”。

   >**注意**：NFS 协议不支持加密，而是依赖于网络级别安全性。 必须禁用此设置才能使 NFS 正常工作。

1. 在“**网络**”选项卡上，执行以下操作，然后选择“**查看**”。

   1. 选择“**启用来自所选虚拟网络和 IP 地址的公共访问**”。
   1. 在“**虚拟网络**”部分中，确保“**虚拟网络订阅**”下拉列表显示在本实验室中使用的 Azure 订阅的名称。
   1. 在“**虚拟网络**”部分的“**虚拟网络**”下拉列表中，选择“**acss-infra-VNET**”。
   1. 在“**子网**”下拉列表中，选择“**应用**”、“**db**”和“**dmz**”子网。

   >**注意**：一般情况下，请避免允许从外围子网访问内部资源。 在这种情况下，此做法的唯一原因是允许在此实验室稍后验证此访问。

1. 在“查看”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：等待预配过程完成。 预配用时应会少于 1 分钟。

1. 在“**部署完成**”面板上，选择“**转到资源**”。
1. 在“存储帐户”页左侧垂直菜单的“**数据存储**”部分中，选择“**文件共享**”，然后选择“**+ 文件共享**”。
1. 在“**新建文件共享**”页的“**基本信息**”选项卡上，指定以下设置，然后选择“**查看 + 创建**”：

   |设置|值|
   |---|---|
   |名称|**事务数**|
   |预配的容量|**** 128|
   |协议|**NFS**|
   |Root 压缩|*No Root Squash**|

1. 在“**查看 + 创建**”选项卡上，等待验证过程完成，然后选择“**创建**”。

   >**注意**：等待文件共享的预配完成。 预配只需几秒钟即可完成。

1. 在“**从 Linux 连接到此 NFS 共享**”页上的“**选择 Linux 分发版**”下拉列表中，选择 Linux 分发下拉列表中的“**SUSE**”，并查看示例命令以装载此 NFS 共享。

#### 任务 7：创建和配置网络安全组

在此任务中，你将创建并配置一个网络安全组 (NSG)，用于限制托管部署的虚拟网络子网的出站访问。 可以通过阻止 Internet 连接，但显式允许连接到以下服务来实现此目的：

- SUSE 或 Red Hat 更新基础结构终结点
- Azure 存储
- Azure Key Vault
- Microsoft Entra ID
- Azure Resource Manager

>**注意**：通常，应考虑使用 Azure 防火墙而不是 NSG 来保护 SAP 部署的网络连接。 此实验室涵盖这两个选项。

1. 在实验室计算机上，在显示 Azure 门户的 Web 浏览器窗口的“**搜索**”文本框中搜索并选择“**网络安全组**”。
1. 在“网络安全组”页上，选择“+ 创建”。
1. 在“创建网络安全组”页的“基本信息”选项卡上，指定以下设置，然后选择“查看 + 创建”************：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**新**资源组的名称为 **ACSS-DEMO**|
   |名称|**acss-infra-NSG**|
   |区域|本练习前面使用的同一 Azure 区域的名称|

1. 在“查看 + 创建”选项卡上，等待验证过程完成并选择“创建”********。

   >**注意**：等待预配过程完成。 预配用时应会少于 1 分钟。

1. 在“**部署完成**”面板上，选择“**转到资源**”。

   >**注意**：默认情况下，网络安全组的内置规则允许所有出站流量、同一虚拟网络中的所有流量以及对等互连虚拟网络之间的所有流量。 从安全角度来看，应考虑限制此默认行为。 建议的配置将限制到 Internet 和 Azure 的出站连接。 还可以使用 NSG 规则来限制虚拟网络中的连接。

1. 在“**acss-infra-NSG**”页面上左侧垂直导航菜单中，在“**设置**”部分中，选择“**出站安全规则**”。
1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置，然后选择“**添加**”：

   >**注意**：应添加以下规则以显式允许连接到 Red Hat 更新基础结构终结点。

   >**注意**：若要标识用于 RHEL 的 IP 地址，请参阅[为基础结构部署准备网络](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/prepare-network#allowlist-suse-or-red-hat-endpoints)

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**IP 地址**|
   |目标 IP 地址/CIDR 范围|13.91.47.76,40.85.190.91,52.187.75.218,52.174.163.213,52.237.203.198****|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**300**|
   |名称|**AllowAnyRHELOutbound**|
   |说明|**允许与 RHEL 更新基础结构终结点建立出站连接**|

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   >**注意**：应添加以下规则以显式允许连接到 SUSE 更新基础结构终结点。

   >**注意**：若要标识用于 SUSE 的 IP 地址，请参阅[为基础结构部署准备网络](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/prepare-network#allowlist-suse-or-red-hat-endpoints)

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**IP 地址**|
   |目标 IP 地址/CIDR 范围|52.188.224.179,52.186.168.210,52.188.81.163,40.121.202.140****|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**305**|
   |名称|**AllowAnySUSEOutbound**|
   |说明|**允许与 SUSE 更新基础结构终结点建立出站连接**|

   >**注意**：应添加以下规则以显式允许连接到 Azure 存储。

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**服务标记**|
   |目标服务标记|**存储**|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**400**|
   |名称|**AllowAnyCustomStorageOutbound**|
   |说明|**允许与 Azure 存储建立出站连接**|

   >**注意**：可以将**存储**服务标记替换为特定于区域的标记，例如 **Storage.EastUS**。

   >**注意**：应添加以下规则以显式允许连接到 Azure Key Vault。

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**服务标记**|
   |目标服务标记|**AzureKeyVault**|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**500**|
   |名称|**AllowAnyCustomKeyVaultOutbound**|
   |说明|**允许与 Azure Key Vault 建立出站连接**|

   >**注意**：应添加以下规则以显式允许连接到 Microsoft Entra ID。

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**服务标记**|
   |目标服务标记|**AzureActiveDirectory**|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**600**|
   |名称|**AllowAnyCustomEntraIDOutbound**|
   |说明|**允许与 Microsoft Entra ID 建立出站连接**|

   >**注意**：应添加以下规则以显式允许连接到 Azure 资源管理器。

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**服务标记**|
   |目标服务标记|**AzureResourceManager**|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**允许**|
   |优先级|**700**|
   |名称|**AllowAnyCustomARMOutbound**|
   |说明|**允许与 Azure 资源管理器建立出站连接**|

   >**注意**：应添加最后一条规则以显式阻止与 Internet 的连接。

1. 在“**acss-infra-NSG \| 出站安全规则**”页上，选择“**+ 添加**”。
1. 在“**添加出站安全规则**”窗格中，指定以下设置并选择“**添加**”：

   |设置|值|
   |---|---|
   |源|**任意**|
   |源端口范围|*|
   |目标|**服务标记**|
   |目标服务标记|**Internet**|
   |服务|**自定义**|
   |目标端口范围|*|
   |协议|**任意**|
   |操作|**拒绝**|
   |优先级|**1000**|
   |名称|**DenyAnyCustomInternetOutbound**|
   |说明|**拒绝到 Internet 的出站连接**|

   >**注意**：最后，需要将 NSG 分配到将托管 SAP 部署的虚拟网络的相关子网。

1. 在“**添加出站安全规则**”窗格左侧的垂直导航菜单中，在“**设置**”部分选择“**子网**”。
1. 在“**acss-infra-NSG \| 子网**”页上，选择“**+ 关联**”。
1. 在“**关联子网**”窗格中的“**虚拟网络**”下拉列表中，选择“**acss-intra-VNET (acss-infra-RG)**”，在“**子网**”下拉列表中选择“**应用**”，然后选择“**确定**”。
1. 在“**关联子网**”窗格中的“**虚拟网络**”下拉列表中，选择“**acss-intra-VNET (acss-infra-RG)**”，在“**子网**”下拉列表中选择“**db**”，然后选择“**确定**”。

#### 任务 8：创建一个 Azure 虚拟机

在此任务中，你将创建一个用于 SAP 软件安装的 Azure 虚拟机 (VM)，作为 Azure SAP 解决方案中心的一部分。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**虚拟机**”。
1. 在“**虚拟机**”页上，选择“**+ 创建**”，然后在下拉菜单中选择“**Azure 虚拟机**”。
1. 在“**创建虚拟机**”页的“**基本信息**”选项卡中，指定以下设置并选择“**下一步:** 磁盘 >”（保留所有其他设置的默认值）：

   |设置|值|
   |---|---|
   |订阅|在本实验室中使用的 Azure 订阅的名称|
   |资源组|**acss-infra-RG**|
   |虚拟机名称|**acss-infra-vm0**|
   |区域|本练习前面使用的同一 Azure 区域的名称|
   |可用性选项|**没有所需的基础结构冗余**|
   |安全类型|**受信任启动虚拟机**|
   |映像|**Ubuntu Server 20.04 LTS - x64 Gen2**|
   |VM 架构|**x64**|
   |使用 Azure Spot 折扣运行|disabled|
   |大小|**Standard_B2ms**|
   |身份验证类型|**密码**|
   |用户名|任何有效的用户名|
   |密码|自行设定的任何复杂密码|
   |公共入站端口|**无**|
   
    > **注意**：请确保记住指定的用户名和密码。 本实验室中稍后会用到它。

1. 在“**磁盘**”选项卡上，接受默认值并选择“**下一步:** 网络 >”。
1. 在“**网络**”选项卡上，指定以下设置，然后选择“**下一步:** 管理 >”（保留所有其他设置的默认值）：

   |设置|值 |
   |---|---|
   |虚拟网络|**acss-infra-VNET**|
   |子网|**dmz**|
   |公共 IP 地址|**无**|
   |NIC 网络安全组|**无**|
   |删除 VM 时删除 NIC|enabled|
   |负载平衡选项|**无**|

1. 在“**管理**”选项卡上，保留所有设置的默认值，然后选择“**下一步:监视 >**”
1. 在“**监视**”选项卡上，将“**启动诊断**”设置为“**禁用**”，然后选择“**下一步:高级 >**”（保留所有其他设置的默认值）
1. 在“**高级**”选项卡上，选择“**查看 + 创建**”（保留所有设置的默认值）。
1. 在“**创建虚拟机**”菜单的“**查看 + 创建**”选项卡上，选择“**创建**”。

   > **注意**：等待预配完成。 预配可能需要大约 3 分钟。

#### 任务 9：配置 Azure VM

在此任务中，你将使用 Azure Bastion 连接到 Azure VM，并配置它以进行 SAP 软件安装。 

> **注意**：在开始此任务之前，请确保已完成 Azure Bastion 预配。

> **注意**：确保 Web 浏览器不会阻止弹出窗口，如果阻止，请禁用弹出窗口阻止程序功能。

1. 在实验室计算机上显示 Azure 门户的 Web 浏览器窗口中，在“**搜索**”文本框中搜索并选择“**虚拟机**”。 
1. 在“**虚拟机**”页上，选择“**acss-infra-vm0**”条目。
1. 在“**acss-infra-vm0**”页上的工具栏中，选择“**连接**”，然后在下拉菜单中选择“**通过 Bastion 连接**”。
1. 在“**acss-infra-vm0 \| Bastion**”页上，确保将“**身份验证类型**”设置为“**VM 密码**”，在“**用户名**”和“**密码**”文本框中，输入预配 Azure VM 时设置的用户名和密码，确保启用“**在新的浏览器选项卡中打开**”复选框，然后选择“**连接**”。

   > **注意**：此时应打开另一个 Web 浏览器窗口选项卡，其中显示了在 Azure VM 中运行的 shell 会话。

   > **注意**：要为上传 SAP 安装媒体准备 Ubuntu 服务器，请安装 Azure CLI。

1. 在新打开的浏览器选项卡中，在 shell 会话中运行以下命令以安装 Azure CLI：

   ```bash
   curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
   ```

1. 在 shell 会话中运行以下命令以安装 PIP3：

   ```bash
   sudo apt install python3-pip
   ```

1. 在 shell 会话中运行以下命令以安装 Ansible 2.13.19：

   ```bash
   sudo pip3 install ansible-core==2.13.9
   ```

1. 在 shell 会话中运行以下命令以安装 Ansible galaxy 集合模块：

   ```bash
   sudo ansible-galaxy collection install ansible.netcommon:==5.0.0 -p /opt/ansible/collections
   sudo ansible-galaxy collection install ansible.posix:==1.5.1 -p /opt/ansible/collections
   sudo ansible-galaxy collection install ansible.utils:==2.9.0 -p /opt/ansible/collections
   sudo ansible-galaxy collection install ansible.windows:==1.13.0 -p /opt/ansible/collections
   sudo ansible-galaxy collection install community.general:==6.4.0 -p /opt/ansible/collections
   ```

1. 在 shell 会话中运行以下命令，以从 GitHub 克隆 SAP 自动化示例存储库：

   ```bash
   git clone https://github.com/Azure/SAP-automation-samples.git
   ```

1. 在 shell 会话中运行以下命令，以从 GitHub 克隆 SAP 自动化存储库：

   ```bash
   git clone https://github.com/Azure/sap-automation.git
   ```

1. 在 shell 会话中运行以下命令以终止会话：

   ```bash
   logout
   ```

1. 出现提示时，选择“**关闭**”。

#### 任务 10：删除 Azure 资源

在此任务中，你将移除在此实验室中预配的所有 Azure 资源。

1. 在实验室计算机的显示 Azure 门户的 Web 浏览器窗口中，选择“**Cloud Shell**”图标以打开 Cloud Shell 窗格。 如果需要，请选择“**Bash**”以启动 Bash shell 会话。 

   > **注意**：如果这是你第一次在本实验室中使用的 Azure 订阅中启动 Cloud Shell，系统会要求你创建 Azure 文件共享以保留 Cloud Shell 文件。 如果是，接受默认设置，这样会在自动生成的资源组中创建存储账户。

1. 在“Cloud Shell”窗格中运行以下命令，以删除资源组 **acss-infra-RG** 及其所有资源。

   ```cli
   az group delete --name 'acss-infra-RG' --no-wait --yes
   ```

   > **注意**：该命令以异步方式执行（由 `--nowait` 参数确定），因此，虽然调用 shell 提示符后会立即显示，但需要经过几分钟后才会实际移除资源组及其资源。

1. 关闭 Cloud Shell 窗格。
